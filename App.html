<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Markdown Vault Notes</title>
<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100vh;
    display: flex;
    background: #fafafa;
    color: #212529;
  }

  /* Vaults sidebar */
  #vaults-list {
    width: 20%;
    background: #e9ecef;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    box-shadow: inset -1px 0 5px rgba(0,0,0,0.05);
  }

  #vaults-list-header {
    padding: 18px;
    background: #0d6efd;
    color: white;
    font-size: 1.3em;
    text-align: center;
    font-weight: 700;
    flex-shrink: 0;
    letter-spacing: 1px;
    user-select: none;
  }

  #new-vault-btn {
    background: white;
    border: none;
    padding: 10px;
    margin: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    color: #0d6efd;
    border: 2px solid #0d6efd;
    transition: background-color 0.25s, color 0.25s;
    font-size: 1em;
    user-select: none;
  }

  #new-vault-btn:hover {
    background: #0d6efd;
    color: white;
  }

  #vaults-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #0d6efd #dee2e6;
  }

  #vaults-list ul::-webkit-scrollbar {
    width: 8px;
  }

  #vaults-list ul::-webkit-scrollbar-track {
    background: #dee2e6;
    border-radius: 6px;
  }

  #vaults-list ul::-webkit-scrollbar-thumb {
    background-color: #0d6efd;
    border-radius: 6px;
  }

  #vaults-list ul li {
    padding: 12px 18px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 1.1em;
    transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
    border-left: 4px solid transparent;
  }

  #vaults-list ul li.active,
  #vaults-list ul li:hover {
    background: #cfe2ff;
    color: #084298;
    font-weight: 700;
    border-left-color: #0d6efd;
    box-shadow: inset 3px 0 8px rgba(13,110,253,0.2);
  }

  #vaults-list ul li.empty-message {
    cursor: default;
    font-style: italic;
    color: #6c757d;
  }

  /* Notes sidebar */
  #notes-list {
    width: 28%;
    background: #f8f9fa;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    box-shadow: inset -1px 0 5px rgba(0,0,0,0.05);
  }

  #notes-list-header {
    padding: 18px;
    background: #198754;
    color: white;
    font-size: 1.3em;
    text-align: center;
    font-weight: 700;
    flex-shrink: 0;
    letter-spacing: 1px;
    user-select: none;
  }

  #new-note-btn {
    background: white;
    border: none;
    padding: 12px;
    margin: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    color: #198754;
    border: 2px solid #198754;
    transition: background-color 0.25s, color 0.25s;
    font-size: 1em;
    user-select: none;
  }

  #new-note-btn:hover {
    background: #198754;
    color: white;
  }

  #notes-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #198754 #e9ecef;
  }

  #notes-list ul::-webkit-scrollbar {
    width: 8px;
  }

  #notes-list ul::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 6px;
  }

  #notes-list ul::-webkit-scrollbar-thumb {
    background-color: #198754;
    border-radius: 6px;
  }

  #notes-list ul li {
    padding: 14px 18px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 1.05em;
    transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
    border-left: 4px solid transparent;
  }

  #notes-list ul li.active,
  #notes-list ul li:hover {
    background: #d1e7dd;
    color: #0f5132;
    font-weight: 700;
    border-left-color: #198754;
    box-shadow: inset 3px 0 8px rgba(25,135,84,0.2);
  }

  #notes-list ul li.empty-message {
    cursor: default;
    font-style: italic;
    color: #6c757d;
  }

  /* Editor section */
  #editor {
    flex-grow: 1;
    padding: 24px;
    display: flex;
    flex-direction: column;
    background: white;
    height: 100vh;
    box-sizing: border-box;
  }

  #editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    gap: 12px;
  }

  #note-title {
    font-size: 1.8em;
    padding: 14px 18px;
    border: 1px solid #ced4da;
    border-radius: 10px;
    flex-grow: 1;
    font-weight: 600;
    color: #212529;
    transition: border-color 0.3s, box-shadow 0.3s;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: text;
  }

  #note-title::placeholder {
    color: #adb5bd;
  }

  #note-title:focus {
    outline: none;
    border-color: #198754;
    box-shadow: 0 0 8px #198754aa;
  }

  #toggle-mode-btn {
    padding: 10px 22px;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
    font-weight: 700;
    font-size: 1em;
    transition: background-color 0.3s, box-shadow 0.3s;
    flex-shrink: 0;
  }

  #toggle-mode-btn:hover:not(:disabled) {
    background: #0b5ed7;
    box-shadow: 0 0 8px #0b5ed7cc;
  }

  #toggle-mode-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }

  #delete-note-btn {
    padding: 10px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
    font-weight: 700;
    font-size: 1em;
    transition: background-color 0.3s, box-shadow 0.3s;
    flex-shrink: 0;
  }

  #delete-note-btn:hover:not(:disabled) {
    background: #b02a37;
    box-shadow: 0 0 8px #b02a37cc;
  }

  #delete-note-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }

  #toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    user-select: none;
  }

  .toolbar-btn {
    background: #e9ecef;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1em;
    color: #495057;
    transition: background-color 0.2s, color 0.2s;
    user-select: none;
  }

  .toolbar-btn:disabled {
    background: #f8f9fa;
    color: #adb5bd;
    cursor: not-allowed;
  }

  .toolbar-btn:hover:not(:disabled) {
    background: #ced4da;
    color: #212529;
  }

  #note-content {
    flex-grow: 1;
    resize: none;
    padding: 16px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 16px;
    border: 1px solid #ced4da;
    border-radius: 12px;
    min-height: 280px;
    display: block;
    line-height: 1.6;
    color: #212529;
    transition: border-color 0.3s, box-shadow 0.3s;
    user-select: text;
    caret-color: #198754;
  }

  #note-content:focus {
    outline: none;
    border-color: #198754;
    box-shadow: 0 0 8px #198754aa;
  }

  #preview {
    margin-top: 0;
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: #fff9db;
    color: #212529;
    font-size: 1.1em;
    line-height: 1.6;
    display: none;
    user-select: text;
  }

  /* Markdown styling */
  #preview h1 {
    font-size: 2.2em;
    border-bottom: 2px solid #198754;
    padding-bottom: 6px;
    margin-top: 0;
  }
  #preview h2 {
    font-size: 1.8em;
    border-bottom: 1px solid #198754;
    padding-bottom: 4px;
    margin-top: 1em;
  }
  #preview h3 {
    font-size: 1.4em;
    margin-top: 1em;
  }

  #preview p {
    margin: 0.7em 0;
  }

  #preview ul {
    padding-left: 25px;
    margin: 0.7em 0;
  }

  #preview a {
    color: #0d6efd;
    text-decoration: none;
  }

  #preview a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<!-- Vaults sidebar -->
<div id="vaults-list" role="region" aria-label="Vaults">
  <div id="vaults-list-header">My Vaults</div>
  <button id="new-vault-btn" title="Create a new vault">+ New Vault</button>
  <ul id="vaults-ul"></ul>
</div>

<!-- Notes sidebar -->
<div id="notes-list" role="region" aria-label="Notes">
  <div id="notes-list-header">My Notes</div>
  <button id="new-note-btn" title="Create a new note">+ New Note</button>
  <ul id="notes-ul"></ul>
</div>

<!-- Editor -->
<div id="editor" role="region" aria-label="Note Editor">
  <div id="editor-header">
    <input type="text" id="note-title" placeholder="Note Title" autocomplete="off" />
    <button id="toggle-mode-btn" title="Switch between Edit and Preview">Preview</button>
    <button id="delete-note-btn" title="Delete current note" disabled>Delete</button>
  </div>

  <div id="toolbar" aria-label="Markdown formatting toolbar">
    <button class="toolbar-btn" data-md="# " title="Add H1 heading">H1</button>
    <button class="toolbar-btn" data-md="## " title="Add H2 heading">H2</button>
    <button class="toolbar-btn" data-md="### " title="Add H3 heading">H3</button>
    <button class="toolbar-btn" data-md="**bold**" title="Add Bold text">B</button>
    <button class="toolbar-btn" data-md="*italic*" title="Add Italic text">I</button>
    <button class="toolbar-btn" data-md="[text](url)" title="Add Link">Link</button>
  </div>

  <textarea id="note-content" placeholder="Write your note here..."></textarea>
  <div id="preview" aria-live="polite"></div>
</div>

<script>
// ----------- Data & State -----------

let vaults = [];
let selectedVaultId = null;
let selectedNoteId = null;
let editMode = true; // true = edit, false = preview

// ----------- DOM Elements -----------

const vaultsUl = document.getElementById('vaults-ul');
const newVaultBtn = document.getElementById('new-vault-btn');

const notesUl = document.getElementById('notes-ul');
const newNoteBtn = document.getElementById('new-note-btn');

const noteTitleInput = document.getElementById('note-title');
const noteContentTextarea = document.getElementById('note-content');

const toggleModeBtn = document.getElementById('toggle-mode-btn');
const deleteNoteBtn = document.getElementById('delete-note-btn');

const previewDiv = document.getElementById('preview');

const toolbarBtns = document.querySelectorAll('.toolbar-btn');

// ----------- Util Functions -----------

function generateId() {
  return Math.random().toString(36).substr(2, 10);
}

function saveData() {
  localStorage.setItem('vaults', JSON.stringify(vaults));
  localStorage.setItem('selectedVaultId', selectedVaultId || '');
  localStorage.setItem('selectedNoteId', selectedNoteId || '');
}

function loadData() {
  const savedVaults = localStorage.getItem('vaults');
  const savedVaultId = localStorage.getItem('selectedVaultId');
  const savedNoteId = localStorage.getItem('selectedNoteId');

  vaults = savedVaults ? JSON.parse(savedVaults) : [];
  selectedVaultId = savedVaultId || null;
  selectedNoteId = savedNoteId || null;

  // If no vaults, create a default vault
  if (vaults.length === 0) {
    const defaultVault = { id: generateId(), name: 'Default Vault', notes: [] };
    vaults.push(defaultVault);
    selectedVaultId = defaultVault.id;
    selectedNoteId = null;
    saveData();
  }

  // If selected vault is missing, pick first vault
  if (!vaults.find(v => v.id === selectedVaultId)) {
    selectedVaultId = vaults[0].id;
    selectedNoteId = null;
  }

  // If selected note missing in selected vault, clear
  const selectedVault = vaults.find(v => v.id === selectedVaultId);
  if (selectedVault && !selectedVault.notes.find(n => n.id === selectedNoteId)) {
    selectedNoteId = null;
  }
}

// Escape HTML for preview (simple sanitizer)
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Simple Markdown parser for preview
function parseMarkdown(md) {
  if (!md) return '';

  let html = escapeHtml(md);

  // Headings
  html = html.replace(/^### (.*)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.*)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.*)$/gm, '<h1>$1</h1>');

  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

  // Links [text](url)
  html = html.replace(/\[([^\]]+)]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

  // Unordered lists (lines starting with - or *)
  html = html.replace(/^\s*[-*] (.*)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>)/gms, '<ul>$1</ul>');

  // Paragraphs
  html = html.replace(/^(?!<h|<ul|<li|<p|<blockquote)(.+)$/gm, '<p>$1</p>');

  return html;
}

// ----------- UI Rendering -----------

function renderVaults() {
  vaultsUl.innerHTML = '';

  if (vaults.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'No vaults yet';
    li.classList.add('empty-message');
    vaultsUl.appendChild(li);
    return;
  }

  vaults.forEach(vault => {
    const li = document.createElement('li');
    li.textContent = vault.name;
    li.dataset.id = vault.id;
    if (vault.id === selectedVaultId) li.classList.add('active');
    vaultsUl.appendChild(li);
  });
}

function renderNotes() {
  notesUl.innerHTML = '';

  const vault = vaults.find(v => v.id === selectedVaultId);

  if (!vault || vault.notes.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'No notes yet';
    li.classList.add('empty-message');
    notesUl.appendChild(li);
    return;
  }

  vault.notes.forEach(note => {
    const li = document.createElement('li');
    li.textContent = note.title || '(Untitled)';
    li.dataset.id = note.id;
    if (note.id === selectedNoteId) li.classList.add('active');
    notesUl.appendChild(li);
  });
}

function renderEditor() {
  const vault = vaults.find(v => v.id === selectedVaultId);
  if (!vault) {
    noteTitleInput.value = '';
    noteContentTextarea.value = '';
    noteTitleInput.disabled = true;
    noteContentTextarea.disabled = true;
    deleteNoteBtn.disabled = true;
    toggleModeBtn.disabled = true;
    return;
  }

  noteTitleInput.disabled = false;
  noteContentTextarea.disabled = false;
  toggleModeBtn.disabled = false;

  const note = vault.notes.find(n => n.id === selectedNoteId);

  if (!note) {
    // no note selected: clear inputs, disable delete
    noteTitleInput.value = '';
    noteContentTextarea.value = '';
    deleteNoteBtn.disabled = true;
    return;
  }

  noteTitleInput.value = note.title;
  noteContentTextarea.value = note.content;
  deleteNoteBtn.disabled = false;
}

function updatePreview() {
  if (editMode) {
    previewDiv.style.display = 'none';
    noteContentTextarea.style.display = 'block';
    toggleModeBtn.textContent = 'Preview';
  } else {
    previewDiv.style.display = 'block';
    noteContentTextarea.style.display = 'none';
    toggleModeBtn.textContent = 'Edit';

    previewDiv.innerHTML = parseMarkdown(noteContentTextarea.value);
  }
}

// ----------- Event Handlers -----------

vaultsUl.addEventListener('click', e => {
  if (e.target.tagName === 'LI' && !e.target.classList.contains('empty-message')) {
    const clickedVaultId = e.target.dataset.id;
    if (clickedVaultId !== selectedVaultId) {
      selectedVaultId = clickedVaultId;
      selectedNoteId = null;
      saveData();
      renderVaults();
      renderNotes();
      renderEditor();
      updatePreview();
    }
  }
});

newVaultBtn.addEventListener('click', () => {
  let vaultName = prompt('Enter vault name:', '');
  if (vaultName) {
    vaultName = vaultName.trim();
    if (vaultName.length === 0) {
      alert('Vault name cannot be empty!');
      return;
    }
    // check duplicates
    if (vaults.some(v => v.name.toLowerCase() === vaultName.toLowerCase())) {
      alert('A vault with this name already exists!');
      return;
    }
    const newVault = { id: generateId(), name: vaultName, notes: [] };
    vaults.push(newVault);
    selectedVaultId = newVault.id;
    selectedNoteId = null;
    saveData();
    renderVaults();
    renderNotes();
    renderEditor();
    updatePreview();
  }
});

notesUl.addEventListener('click', e => {
  if (e.target.tagName === 'LI' && !e.target.classList.contains('empty-message')) {
    const clickedNoteId = e.target.dataset.id;
    if (clickedNoteId !== selectedNoteId) {
      selectedNoteId = clickedNoteId;
      saveData();
      renderNotes();
      renderEditor();
      updatePreview();
    }
  }
});

newNoteBtn.addEventListener('click', () => {
  if (!selectedVaultId) {
    alert('Select or create a vault first!');
    return;
  }
  const vault = vaults.find(v => v.id === selectedVaultId);
  if (!vault) return;

  const newNote = {
    id: generateId(),
    title: 'New Note',
    content: ''
  };

  vault.notes.unshift(newNote);
  selectedNoteId = newNote.id;
  saveData();
  renderNotes();
  renderEditor();
  updatePreview();

  noteTitleInput.focus();
  noteTitleInput.select();
});

noteTitleInput.addEventListener('input', e => {
  if (!selectedVaultId || !selectedNoteId) return;
  const vault = vaults.find(v => v.id === selectedVaultId);
  if (!vault) return;
  const note = vault.notes.find(n => n.id === selectedNoteId);
  if (!note) return;

  note.title = e.target.value;
  saveData();
  renderNotes();
});

noteContentTextarea.addEventListener('input', e => {
  if (!selectedVaultId || !selectedNoteId) return;
  const vault = vaults.find(v => v.id === selectedVaultId);
  if (!vault) return;
  const note = vault.notes.find(n => n.id === selectedNoteId);
  if (!note) return;

  note.content = e.target.value;
  saveData();

  if (!editMode) {
    updatePreview();
  }
});

toggleModeBtn.addEventListener('click', () => {
  editMode = !editMode;
  updatePreview();
});

deleteNoteBtn.addEventListener('click', () => {
  if (!selectedVaultId || !selectedNoteId) return;

  const vault = vaults.find(v => v.id === selectedVaultId);
  if (!vault) return;

  const idx = vault.notes.findIndex(n => n.id === selectedNoteId);
  if (idx === -1) return;

  if (!confirm(`Are you sure you want to delete the note "${vault.notes[idx].title}"?`)) {
    return;
  }

  vault.notes.splice(idx, 1);
  selectedNoteId = vault.notes.length > 0 ? vault.notes[0].id : null;
  saveData();
  renderNotes();
  renderEditor();
  updatePreview();
});

toolbarBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    if (!selectedVaultId || !selectedNoteId || !editMode) return;

    const mdSyntax = btn.dataset.md;
    if (!mdSyntax) return;

    const textarea = noteContentTextarea;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;

    let insertText = mdSyntax;

    // If mdSyntax is a formatting markup (like **bold**), try to wrap selection if any
    if (mdSyntax === '**bold**') {
      if (start !== end) {
        const selectedText = text.slice(start, end);
        insertText = `**${selectedText}**`;
      }
    } else if (mdSyntax === '*italic*') {
      if (start !== end) {
        const selectedText = text.slice(start, end);
        insertText = `*${selectedText}*`;
      }
    } else if (mdSyntax === '[text](url)') {
      if (start !== end) {
        const selectedText = text.slice(start, end);
        insertText = `[${selectedText}](url)`;
      }
    } else {
      // For headings and other insertions at cursor
      insertText = mdSyntax;
    }

    const newValue = text.slice(0, start) + insertText + text.slice(end);

    textarea.value = newValue;
    textarea.focus();

    // Set cursor inside the markup for link
    if (mdSyntax === '[text](url)') {
      const cursorPos = start + 1; // after [
      textarea.selectionStart = cursorPos;
      textarea.selectionEnd = cursorPos + (end - start);
    } else if (mdSyntax === '**bold**' || mdSyntax === '*italic*') {
      // Select the inserted bold/italic text (excluding the markers)
      const offset = mdSyntax.length / 2;
      textarea.selectionStart = start + offset;
      textarea.selectionEnd = start + offset + (end - start);
    } else {
      textarea.selectionStart = textarea.selectionEnd = start + insertText.length;
    }

    // Trigger input event to update data and save
    const event = new Event('input', { bubbles: true });
    textarea.dispatchEvent(event);
  });
});

// Keyboard shortcut: Ctrl+S or Cmd+S to save (just to simulate)
window.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
    e.preventDefault();
    saveData();
    alert('Notes saved!');
  }
});

// ----------- Initialization -----------

function init() {
  loadData();
  renderVaults();
  renderNotes();
  renderEditor();
  updatePreview();
}

init();
</script>
</body>
</html>
