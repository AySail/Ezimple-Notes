<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ezimple Notes</title>
<style>
  /* === Reset & base === */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #fff;
    color: #222;
  }
  button {
    cursor: pointer;
  }

  /* === Layout === */
  #app {
    flex: 1;
    display: flex;
    height: 100%;
    overflow: hidden;
  }
  #vaultSidebar {
    width: 200px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    background: #f9f9f9;
  }
  #vaultSidebar header {
    padding: 1em;
    font-weight: bold;
    font-size: 1.2em;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #vaultList {
    flex: 1;
    overflow-y: auto;
  }
  .vault-item {
    padding: 0.5em 1em;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .vault-item.selected {
    background: #d0e4ff;
    font-weight: bold;
  }
  .vault-item:hover {
    background: #eee;
  }
  .vault-item button {
    background: transparent;
    border: none;
    color: #888;
    font-size: 1em;
  }

  /* Notes sidebar */
  #notesSidebar {
    width: 250px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    background: #fafafa;
  }
  #notesSidebar header {
    padding: 1em;
    font-weight: bold;
    font-size: 1.1em;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #notesList {
    flex: 1;
    overflow-y: auto;
  }
  .note-item {
    padding: 0.4em 1em;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .note-item.selected {
    background: #cce5ff;
    font-weight: bold;
  }
  .note-item:hover {
    background: #eee;
  }
  .note-item button {
    background: transparent;
    border: none;
    color: #888;
    font-size: 1em;
  }

  /* Main editor and preview */
  #mainContent {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #noteTitleBar {
    padding: 0.5em 1em;
    border-bottom: 1px solid #ddd;
    background: #f7f7f7;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #noteTitleBar input {
    font-size: 1.25em;
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
  }
  #tagInput {
    padding: 4px 8px;
    font-size: 0.9em;
    border: 1px solid #ccc;
    border-radius: 3px;
    width: 150px;
  }
  #tagsContainer {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .tag {
    background: #d0e4ff;
    color: #00529b;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tag button {
    border: none;
    background: transparent;
    font-weight: bold;
    cursor: pointer;
    color: #00529b;
    padding: 0;
    font-size: 1em;
    line-height: 1;
  }

  /* Editor + Preview container */
  #editorPreview {
    flex: 1;
    display: flex;
    height: 100%;
    overflow: hidden;
  }

  /* Textarea editor */
  #noteContent {
    flex: 1;
    padding: 1em;
    border: none;
    resize: none;
    font-family: "Fira Mono", monospace, monospace;
    font-size: 1em;
    line-height: 1.4;
    border-right: 1px solid #ddd;
    outline: none;
    overflow-y: auto;
  }

  /* Preview pane */
  #previewPane {
    flex: 1;
    padding: 1em;
    overflow-y: auto;
    background: #fff;
    border-left: 1px solid #ddd;
  }
  #previewPane h1, #previewPane h2, #previewPane h3 {
    margin-top: 1em;
    margin-bottom: 0.3em;
  }
  #previewPane a {
    color: #1a0dab;
    cursor: pointer;
    text-decoration: underline;
  }
  #previewPane pre {
    background: #eee;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
  }
  #previewPane code {
    font-family: monospace;
    background: #eee;
    padding: 2px 4px;
    border-radius: 3px;
  }

  /* Toolbar */
  #toolbar {
    padding: 0.5em 1em;
    border-bottom: 1px solid #ddd;
    background: #f7f7f7;
    display: flex;
    gap: 8px;
  }
  .toolbar-btn {
    padding: 4px 8px;
    border: 1px solid #bbb;
    background: #fff;
    border-radius: 4px;
    font-size: 0.9em;
    user-select: none;
  }
  .toolbar-btn:hover {
    background: #d0e4ff;
    border-color: #4a90e2;
  }
  .toolbar-btn:active {
    background: #a0c4ff;
  }
  #previewToggleBtn.active {
    background: #4a90e2;
    color: white;
  }
  #fullPreviewToggleBtn.active {
    background: #7b61ff;
    color: white;
  }

  /* Responsive */
  @media (max-width: 900px) {
    #vaultSidebar {
      width: 120px;
    }
    #notesSidebar {
      width: 180px;
    }
  }
  @media (max-width: 600px) {
    #vaultSidebar, #notesSidebar {
      display: none;
    }
    #mainContent {
      flex: 1;
    }
  }
</style>
</head>
<body>
<div id="app">
  <nav id="vaultSidebar" aria-label="Vaults">
    <header>
      Vaults
      <button id="addVaultBtn" title="Add Vault">+ Vault</button>
    </header>
    <div id="vaultList" role="list" tabindex="0"></div>
  </nav>

  <nav id="notesSidebar" aria-label="Notes">
    <header>
      Notes
      <button id="addNoteBtn" title="Add Note">+ Note</button>
    </header>
    <div id="notesList" role="list" tabindex="0"></div>
  </nav>

  <section id="mainContent">
    <div id="noteTitleBar">
      <input id="noteTitleInput" type="text" placeholder="Note Title" aria-label="Note Title" />
      <input id="tagInput" type="text" placeholder="Add tag (press Enter)" aria-label="Add tag" />
      <div id="tagsContainer" aria-live="polite" aria-atomic="true"></div>
    </div>

    <div id="toolbar" role="toolbar" aria-label="Markdown formatting toolbar">
      <button class="toolbar-btn" data-md="bold" title="Bold (Ctrl+B)"><b>B</b></button>
      <button class="toolbar-btn" data-md="italic" title="Italic (Ctrl+I)"><i>I</i></button>
      <button class="toolbar-btn" data-md="h1" title="Heading 1">H1</button>
      <button class="toolbar-btn" data-md="h2" title="Heading 2">H2</button>
      <button class="toolbar-btn" data-md="h3" title="Heading 3">H3</button>
      <button class="toolbar-btn" data-md="ul" title="Bullet List">â€¢ List</button>
      <button class="toolbar-btn" data-md="ol" title="Numbered List">1. List</button>
      <button class="toolbar-btn" data-md="link" title="Link">ðŸ”—</button>
      <button class="toolbar-btn" data-md="code" title="Code">Code</button>
      <button id="previewToggleBtn" class="toolbar-btn" title="Toggle Preview">Preview</button>
      <button id="fullPreviewToggleBtn" class="toolbar-btn" title="Full Preview">Full View</button>
    </div>

    <div id="editorPreview">
      <textarea id="noteContent" placeholder="Write your markdown note here..." spellcheck="false" aria-label="Note content"></textarea>
      <div id="previewPane" aria-live="polite" aria-atomic="true" tabindex="0"></div>
    </div>
  </section>
</div>

<script>
  /* === DATA STORAGE === */
  let vaults = [];
  let selectedVaultId = null;
  let selectedNoteId = null;

  /* === DOM ELEMENTS === */
  const vaultListEl = document.getElementById("vaultList");
  const notesListEl = document.getElementById("notesList");
  const addVaultBtn = document.getElementById("addVaultBtn");
  const addNoteBtn = document.getElementById("addNoteBtn");
  const noteTitleInput = document.getElementById("noteTitleInput");
  const tagInput = document.getElementById("tagInput");
  const tagsContainer = document.getElementById("tagsContainer");
  const noteContentTextarea = document.getElementById("noteContent");
  const previewPane = document.getElementById("previewPane");
  const previewToggleBtn = document.getElementById("previewToggleBtn");
  const fullPreviewToggleBtn = document.getElementById("fullPreviewToggleBtn");
  const editorPreview = document.getElementById("editorPreview");

  /* === STATE === */
  let isPreview = true;
  let isFullPreview = false;

  /* === UTILITIES === */
  function generateId() {
    return Math.random().toString(36).slice(2, 10);
  }

  /* === STORAGE === */
  function saveVaults() {
    localStorage.setItem("ezimple_vaults", JSON.stringify(vaults));
  }
  function loadVaults() {
    const saved = localStorage.getItem("ezimple_vaults");
    if (saved) {
      vaults = JSON.parse(saved);
    } else {
      vaults = [];
    }
  }

  /* === GETTERS === */
  function getVault(id) {
    return vaults.find(v => v.id === id);
  }
  function getNote(vault, noteId) {
    return vault.notes.find(n => n.id === noteId);
  }

  /* === RENDER VAULTS === */
  function renderVaults() {
    vaultListEl.innerHTML = "";
    vaults.forEach(vault => {
      const div = document.createElement("div");
      div.className = "vault-item";
      if (vault.id === selectedVaultId) div.classList.add("selected");
      div.textContent = vault.name;
      div.tabIndex = 0;

      // Right click context menu for rename/delete
      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        const choice = prompt(`Rename vault "${vault.name}" or type DELETE to remove it:`, vault.name);
        if (choice === null) return;
        if (choice.trim().toUpperCase() === "DELETE") {
          // Delete vault
          if (confirm(`Are you sure you want to delete vault "${vault.name}"? This cannot be undone.`)) {
            vaults = vaults.filter(v => v.id !== vault.id);
            if (selectedVaultId === vault.id) {
              selectedVaultId = vaults.length ? vaults[0].id : null;
              selectedNoteId = null;
            }
            saveVaults();
            renderAll();
          }
          return;
        }
        if (!choice.trim()) return;
        vault.name = choice.trim();
        saveVaults();
        renderVaults();
      });

      // Click to select vault
      div.addEventListener("click", () => {
        if (selectedVaultId !== vault.id) {
          selectedVaultId = vault.id;
          selectedNoteId = vault.notes.length ? vault.notes[0].id : null;
          renderAll();
        }
      });

      vaultListEl.appendChild(div);
    });
  }

  /* === RENDER NOTES === */
  function renderNotes() {
    notesListEl.innerHTML = "";
    const vault = getVault(selectedVaultId);
    if (!vault) return;
    vault.notes.forEach(note => {
      const div = document.createElement("div");
      div.className = "note-item";
      if (note.id === selectedNoteId) div.classList.add("selected");
      div.textContent = note.title;
      div.tabIndex = 0;

      // Right click to rename/delete
      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        const choice = prompt(`Rename note "${note.title}" or type DELETE to remove it:`, note.title);
        if (choice === null) return;
        if (choice.trim().toUpperCase() === "DELETE") {
          // Delete note
          if (confirm(`Are you sure you want to delete note "${note.title}"?`)) {
            vault.notes = vault.notes.filter(n => n.id !== note.id);
            if (selectedNoteId === note.id) {
              selectedNoteId = vault.notes.length ? vault.notes[0].id : null;
            }
            saveVaults();
            renderAll();
          }
          return;
        }
        if (!choice.trim()) return;
        note.title = choice.trim();
        saveVaults();
        renderNotes();
        if (selectedNoteId === note.id) {
          noteTitleInput.value = note.title;
          updatePreview();
        }
      });

      // Click to select note
      div.addEventListener("click", () => {
        if (selectedNoteId !== note.id) {
          selectedNoteId = note.id;
          renderAll();
        }
      });

      notesListEl.appendChild(div);
    });
  }

  /* === RENDER TAGS === */
  function renderTags() {
    const note = getCurrentNote();
    tagsContainer.innerHTML = "";
    if (!note || !note.tags) return;
    note.tags.forEach(tag => {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = tag;
      const btn = document.createElement("button");
      btn.textContent = "Ã—";
      btn.title = "Remove tag";
      btn.addEventListener("click", () => {
        note.tags = note.tags.filter(t => t !== tag);
        saveVaults();
        renderTags();
      });
      span.appendChild(btn);
      tagsContainer.appendChild(span);
    });
  }

  /* === UPDATE PREVIEW === */
  function updatePreview() {
    const note = getCurrentNote();
    if (!note) {
      previewPane.innerHTML = "<em>No note selected</em>";
      return;
    }
    // Convert markdown to HTML (simple parser)
    // Also handle [[Link]] syntax to link to other notes
    let md = note.content || "";
    md = md
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    // Headers
    md = md.replace(/^### (.*)$/gm, "<h3>$1</h3>");
    md = md.replace(/^## (.*)$/gm, "<h2>$1</h2>");
    md = md.replace(/^# (.*)$/gm, "<h1>$1</h1>");

    // Bold **text**
    md = md.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    // Italic *text*
    md = md.replace(/\*(.*?)\*/g, "<em>$1</em>");
    // Inline code `code`
    md = md.replace(/`([^`\n]+)`/g, "<code>$1</code>");

    // Links [text](url)
    md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, `<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>`);

    // Bullet lists
    md = md.replace(/^\s*â€¢ (.*)$/gm, "<li>$1</li>");
    md = md.replace(/(<li>.*<\/li>)/gms, "<ul>$1</ul>");

    // Numbered lists
    md = md.replace(/^\s*\d+\. (.*)$/gm, "<li>$1</li>");
    md = md.replace(/(<li>.*<\/li>)/gms, "<ol>$1</ol>");

    // Line breaks (replace single \n with <br>)
    md = md.replace(/\n/g, "<br>");

    // Custom link syntax for linking other notes: [[Note Title]]
    md = md.replace(/\[\[([^\]]+)\]\]/g, (match, p1) => {
      // Find note by title in current vault
      const vault = getVault(selectedVaultId);
      if (!vault) return p1;
      const linkedNote = vault.notes.find(n => n.title === p1);
      if (!linkedNote) return p1;
      // Make clickable link to switch note
      return `<a href="#" class="note-link" data-note-id="${linkedNote.id}">${p1}</a>`;
    });

    previewPane.innerHTML = md;

    // Attach click handlers on links to notes
    [...previewPane.querySelectorAll(".note-link")].forEach(a => {
      a.addEventListener("click", e => {
        e.preventDefault();
        const noteId = e.target.dataset.noteId;
        if (noteId && selectedNoteId !== noteId) {
          selectedNoteId = noteId;
          renderAll();
        }
      });
    });
  }

  /* === RENDER ALL === */
  function renderAll() {
    renderVaults();
    renderNotes();
    const vault = getVault(selectedVaultId);
    const note = vault ? getNote(vault, selectedNoteId) : null;

    if (note) {
      noteTitleInput.value = note.title;
      noteContentTextarea.value = note.content || "";
      renderTags();
    } else {
      noteTitleInput.value = "";
      noteContentTextarea.value = "";
      tagsContainer.innerHTML = "";
    }
    updatePreview();
    updatePreviewVisibility();
  }

  /* === CURRENT NOTE === */
  function getCurrentNote() {
    const vault = getVault(selectedVaultId);
    if (!vault) return null;
    return getNote(vault, selectedNoteId);
  }

  /* === ADD VAULT === */
  addVaultBtn.addEventListener("click", () => {
    const name = prompt("Enter new vault name:");
    if (!name || !name.trim()) return;
    vaults.push({
      id: generateId(),
      name: name.trim(),
      notes: [],
    });
    selectedVaultId = vaults[vaults.length - 1].id;
    selectedNoteId = null;
    saveVaults();
    renderAll();
  });

  /* === ADD NOTE === */
  addNoteBtn.addEventListener("click", () => {
    if (!selectedVaultId) {
      alert("Please select or create a vault first.");
      return;
    }
    const vault = getVault(selectedVaultId);
    const title = prompt("Enter new note title:");
    if (!title || !title.trim()) return;
    const newNote = {
      id: generateId(),
      title: title.trim(),
      content: "",
      tags: [],
    };
    vault.notes.push(newNote);
    selectedNoteId = newNote.id;
    saveVaults();
    renderAll();
  });

  /* === NOTE TITLE EDIT === */
  noteTitleInput.addEventListener("input", () => {
    const note = getCurrentNote();
    if (!note) return;
    note.title = noteTitleInput.value.trim() || "Untitled";
    saveVaults();
    renderNotes();
  });

  /* === NOTE CONTENT EDIT === */
  noteContentTextarea.addEventListener("input", () => {
    const note = getCurrentNote();
    if (!note) return;
    note.content = noteContentTextarea.value;
    saveVaults();
    if (isPreview) updatePreview();
  });

  /* === TAG INPUT === */
  tagInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      const val = tagInput.value.trim();
      if (!val) return;
      const note = getCurrentNote();
      if (!note) return;
      note.tags = note.tags || [];
      if (!note.tags.includes(val)) {
        note.tags.push(val);
        saveVaults();
        renderTags();
      }
      tagInput.value = "";
    }
  });

  /* === REMOVE TAGS handled in renderTags() with buttons === */

  /* === TOOLBAR BUTTONS === */
  document.querySelectorAll(".toolbar-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const md = btn.dataset.md;
      if (!md) return;
      insertMarkdown(md);
    });
  });

  /* === INSERT MARKDOWN TEXT AT CURSOR POSITION === */
  function insertMarkdown(type) {
    const textarea = noteContentTextarea;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.slice(start, end);

    let insertText = "";
    let cursorOffset = 0;

    switch(type) {
      case "bold":
        insertText = `**${selected || "bold text"}**`;
        cursorOffset = selected ? 0 : 10;
        break;
      case "italic":
        insertText = `*${selected || "italic text"}*`;
        cursorOffset = selected ? 0 : 12;
        break;
      case "h1":
        insertText = `# ${selected || "Heading 1"}`;
        cursorOffset = selected ? 0 : 9;
        break;
      case "h2":
        insertText = `## ${selected || "Heading 2"}`;
        cursorOffset = selected ? 0 : 9;
        break;
      case "h3":
        insertText = `### ${selected || "Heading 3"}`;
        cursorOffset = selected ? 0 : 9;
        break;
      case "ul":
        insertText = selected
          ? selected.split("\n").map(line => "â€¢ " + line).join("\n")
          : "â€¢ List item";
        cursorOffset = selected ? 0 : 10;
        break;
      case "ol":
        insertText = selected
          ? selected.split("\n").map((line, i) => (i+1) + ". " + line).join("\n")
          : "1. List item";
        cursorOffset = selected ? 0 : 11;
        break;
      case "link":
        insertText = `[${selected || "link text"}](url)`;
        cursorOffset = selected ? 0 : 11;
        break;
      case "code":
        insertText = `\`${selected || "code"}\``;
        cursorOffset = selected ? 0 : 6;
        break;
    }

    const before = text.slice(0, start);
    const after = text.slice(end);
    textarea.value = before + insertText + after;
    textarea.focus();
    if (!selected) {
      textarea.selectionStart = textarea.selectionEnd = start + insertText.length - cursorOffset;
    } else {
      textarea.selectionStart = start;
      textarea.selectionEnd = start + insertText.length;
    }

    // Trigger input event to save and update preview
    textarea.dispatchEvent(new Event("input"));
  }

  /* === PREVIEW TOGGLE === */
  previewToggleBtn.addEventListener("click", () => {
    isPreview = !isPreview;
    updatePreviewVisibility();
  });

  /* === FULL PREVIEW TOGGLE === */
  fullPreviewToggleBtn.addEventListener("click", () => {
    isFullPreview = !isFullPreview;
    updatePreviewVisibility();
  });

  /* === UPDATE PREVIEW VISIBILITY === */
  function updatePreviewVisibility() {
    if (isFullPreview) {
      // Preview pane takes full editorPreview area
      previewPane.style.display = "block";
      noteContentTextarea.style.display = "none";
      previewToggleBtn.classList.remove("active");
      fullPreviewToggleBtn.classList.add("active");
    } else if (isPreview) {
      // Show editor + preview side by side
      previewPane.style.display = "block";
      noteContentTextarea.style.display = "block";
      previewToggleBtn.classList.add("active");
      fullPreviewToggleBtn.classList.remove("active");
    } else {
      // Show only editor
      previewPane.style.display = "none";
      noteContentTextarea.style.display = "block";
      previewToggleBtn.classList.remove("active");
      fullPreviewToggleBtn.classList.remove("active");
    }
  }

  /* === INITIAL LOAD === */
  loadVaults();
  if (vaults.length) {
    selectedVaultId = vaults[0].id;
    const vault = getVault(selectedVaultId);
    if (vault && vault.notes.length) selectedNoteId = vault.notes[0].id;
  }
  renderAll();
</script>
</body>
</html>
